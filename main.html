<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>RSVP</title>

  <!-- fonts & theme -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="card">

    <!-- Decorative invitation (static image) -->
    <img src="images/A_Wedding_Inv.png" alt="Wedding invitation" class="img-full">

    <!-- Seat-specific RSVP card swaps in once we know the seat count -->
    <img id="rsvpImg" class="img-full" alt="RSVP card showing reserved seats" style="display:none">

    <h1>Please respond</h1>

    <form id="form">
      <div style="margin:1rem 0">
        <label><input type="radio" name="reply" value="yes" required> Yes</label>
        <label style="margin-left:1.5rem"><input type="radio" name="reply" value="no" required> No</label>
      </div>
      <button class="btn" type="submit">Submit</button>
    </form>

    <p id="msg" class="success">Saved â€” redirectingâ€¦</p>
  </div>

<!-- Firebase SDKs -->
<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
import {getFirestore, doc, getDoc, setDoc, Timestamp}
        from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

/* ðŸ”§ YOUR PROJECT KEYS */
const app = initializeApp({
  apiKey: "AIzaSyD5N9MzxEeVghPM_R7CDlBrlWlZMAU95T0",
  authDomain: "gerzlngelairsvp.firebaseapp.com",
  projectId: "gerzlngelairsvp",
  storageBucket: "gerzlngelairsvp.firebasestorage.app",
  messagingSenderId: "367774281093",
  appId: "1:367774281093:web:b134d69d29e370c19fe8ec",
  measurementId: "G-RQH6M218SX"
});
const db = getFirestore(app);

/* â”€â”€ pull invite code from URL â”€â”€ */
const code = new URLSearchParams(location.search).get('code')?.toUpperCase();
if (!code || code.length!==6){
  document.querySelector('.card').innerHTML='<p class=error>Bad link â€” missing invite code.</p>';
  throw new Error();
}

/* â”€â”€ look up seat count â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let seats = 1;                                                // default
try{
  const metaSnap = await getDoc(doc(db,'invites',code));
  if (metaSnap.exists()) seats = Math.max(1, Math.min(5, metaSnap.data().seats||1));
}catch(e){console.warn('No invite metadata for',code)}

/* show the correct image */
const rsvpImg = document.getElementById('rsvpImg');
rsvpImg.src   = `images/C_RSVP_${seats}.png`;
rsvpImg.style.display='block';

/* â”€â”€ handle form submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const form=document.getElementById('form'), msg=document.getElementById('msg');
form.addEventListener('submit',async e=>{
  e.preventDefault();
  const attending=new FormData(form).get('reply')==='yes';
  const ref=doc(db,'rsvps',code);
  const snap=await getDoc(ref);
  let updates=snap.exists()?snap.data().updates||[]:[];
  if(updates.length>=5){
    alert('Edit limit reached (5).');
    location.href=`status.html?code=${code}`;
    return;
  }
  updates.push({attending,ts:Timestamp.now()});
  await setDoc(ref,{updates,seats},{merge:true});      // store seats for reference
  msg.style.display='block';
  setTimeout(()=>location.href=`status.html?code=${code}`,700);
});
</script>
</body>
</html>
