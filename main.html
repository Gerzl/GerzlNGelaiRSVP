<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>RSVP</title>

  <!-- fonts & shared CSS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="card">

    <!-- Decorative invitation -->
    <img src="images/A_Wedding_Inv.png"
         alt="Wedding invitation"
         class="img-block">

    <!-- Seat-specific RSVP card (swapped in via JS) -->
    <img id="rsvpImg"
         alt="RSVP card showing seats reserved"
         class="img-block">

    <h1>Please respond</h1>

    <form id="form">
      <div style="margin:1rem 0">
        <label><input type="radio" name="reply" value="yes" required> Yes</label>
        <label style="margin-left:1.5rem"><input type="radio" name="reply" value="no"  required> No</label>
      </div>
      <button class="btn" type="submit">Submit</button>
    </form>

    <p id="msg" class="success" style="display:none">Saved â€” redirectingâ€¦</p>
    <p id="err" class="error"  style="display:none">Couldnâ€™t save. Try again?</p>
  </div>

<!-- Firebase SDK -->
<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
import {getFirestore, doc, getDoc, setDoc, Timestamp}
        from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

/* ðŸ”§ YOUR PROJECT KEYS */
const app = initializeApp({
  apiKey: "AIzaSyD5N9MzxEeVghPM_R7CDlBrlWlZMAU95T0",
  authDomain: "gerzlngelairsvp.firebaseapp.com",
  projectId: "gerzlngelairsvp",
  storageBucket: "gerzlngelairsvp.firebasestorage.app",
  messagingSenderId: "367774281093",
  appId: "1:367774281093:web:b134d69d29e370c19fe8ec",
  measurementId: "G-RQH6M218SX"
});
const db = getFirestore(app);

/* â”€â”€ extract code from URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const code = new URLSearchParams(location.search).get('code')?.toUpperCase();
if (!code || code.length !== 6) {
  document.querySelector('.card').innerHTML =
    '<p class="error">Bad link â€” missing invite code.</p>';
  throw new Error('Missing code');
}

/* â”€â”€ look up seat count & show correct card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let seats = 1;
try {
  const metaSnap = await getDoc(doc(db,'invites',code));
  if (metaSnap.exists()) seats = Math.max(1, Math.min(5, metaSnap.data().seats || 1));
} catch(err) {
  console.error('Seat lookup failed:', err);
}
const rsvpImg = document.getElementById('rsvpImg');
rsvpImg.src   = `images/C_RSVP_${seats}.png`;
rsvpImg.style.display = 'block';

/* â”€â”€ handle submission â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const form = document.getElementById('form');
const msg  = document.getElementById('msg');
const errP = document.getElementById('err');

form.addEventListener('submit', async e => {
  e.preventDefault();
  errP.style.display = 'none';

  /* current choice */
  const attending = new FormData(form).get('reply') === 'yes';

  /* read-modify-write cycle */
  try {
    const ref  = doc(db,'rsvps',code);
    const snap = await getDoc(ref);
    let updates = snap.exists() ? (snap.data().updates || []) : [];

    if (updates.length >= 5) {
      alert('Edit limit reached (5 changes).');
      location.href = `status.html?code=${code}`;
      return;
    }

    updates.push({attending, ts: Timestamp.now()});
    await setDoc(ref, {updates}, {merge:true});      // â¬…ï¸Ž no seats field

    msg.style.display = 'block';
    setTimeout(() => location.href=`status.html?code=${code}`, 700);

  } catch (err) {
    console.error(err);
    errP.style.display = 'block';
  }
});
</script>
</body>
</html>
